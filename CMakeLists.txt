project(gTox)
cmake_minimum_required(VERSION 2.8)

set(CMAKE_BUILD_TYPE Debug)
SET(CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS} -std=c++11 -Wall -Wextra -rdynamic -g3")

find_package(PkgConfig)
pkg_check_modules(GTKMM gtkmm-3.0)
pkg_check_modules(LIBNOTIFYMM libnotifymm-1.0)
link_directories(
    ${GTKMM_LIBRARY_DIRS} ${LIBNOTIFYMM_LIBRARY_DIRS})
include_directories(
    ${GTKMM_INCLUDE_DIRS} ${LIBNOTIFYMM_INCLUDE_DIRS})

if(NOT SUBMODULES_INITED)
  execute_process(
    COMMAND git submodule init
    WORKING_DIRECTORY "${CMAKE_CURRENT_SOURCE_DIR}"
  )
  execute_process(
    COMMAND git submodule update
    WORKING_DIRECTORY "${CMAKE_CURRENT_SOURCE_DIR}"
  )
  set(SUBMODULES_INITED TRUE CACHE BOOL "Are submodules pulled ?" FORCE)
endif()

if(NOT TOXCORE_INITED)
  execute_process(
    COMMAND ./autogen.sh
    WORKING_DIRECTORY "${CMAKE_CURRENT_SOURCE_DIR}/toxcore"
  )
  execute_process(
    COMMAND ./configure
    WORKING_DIRECTORY "${CMAKE_CURRENT_SOURCE_DIR}/toxcore"
  )
  set(TOXCORE_INITED TRUE CACHE BOOL "Is toxcore configured ?" FORCE)
endif()

add_custom_target(
   toxcore
   COMMAND make
   WORKING_DIRECTORY "${CMAKE_CURRENT_SOURCE_DIR}/toxcore"
)

add_subdirectory(Tools)
add_subdirectory(Theme)
add_subdirectory(Icons)

set(SOURCES
    main.cpp
    Widget/WidgetChat.cpp
    Widget/WidgetContact.cpp
    Widget/WidgetContactListItem.cpp
    Widget/WidgetChatBox.cpp
    Widget/WidgetChatLine.cpp
    Popover/PopoverStatus.cpp
    Popover/PopoverSettings.cpp
    Popover/PopoverAddContact.cpp
    Popover/PopoverContextContact.cpp
    Widget/Assistant/WelcomePage.cpp
    Widget/Assistant/AccountWidget.cpp
    Widget/Assistant/NewAccountWidget.cpp
    Dialog/FirstStartAssistant.cpp
    Dialog/DialogChat.cpp
    Dialog/DialogContact.cpp
    Widget/WidgetNotification.cpp
    Dialog/Debug/DialogCss.cpp
    Tox/Tox.cpp)

add_executable(${PROJECT_NAME}
     ${SOURCES}
    "${CMAKE_CURRENT_SOURCE_DIR}/Generated/icon.cpp"
    "${CMAKE_CURRENT_SOURCE_DIR}/Generated/theme.cpp"
)
include_directories(${CMAKE_CURRENT_SOURCE_DIR})
target_link_libraries(${PROJECT_NAME} ${GTKMM_LIBRARIES} ${LIBNOTIFYMM_LIBRARIES} "${CMAKE_CURRENT_SOURCE_DIR}/toxcore/build/.libs/libtoxcore.a" -lsodium -lpthread)
add_dependencies(${PROJECT_NAME} toxcore)
install(PROGRAMS "${PROJECT_BINARY_DIR}/${PROJECT_NAME}"
        DESTINATION bin
        PERMISSIONS OWNER_EXECUTE OWNER_WRITE OWNER_READ GROUP_EXECUTE GROUP_READ WORLD_EXECUTE WORLD_READ)

add_subdirectory(Locale)

add_custom_command(
   COMMENT "Generate pot file"
   TARGET ${PROJECT_NAME}
   PRE_BUILD
   COMMAND xgettext -o "${CMAKE_CURRENT_SOURCE_DIR}/Locale/template.pot" --from-code=UTF-8 --c++ --omit-header -k_ -s ${SOURCES}
   DEPENDS ${SOURCES}
   WORKING_DIRECTORY "${CMAKE_CURRENT_SOURCE_DIR}")
